<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Seva Mela - VCD Department">
  <meta name="theme-color" content="#f97316">
  <title>Seva Mela - VCD Department</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding-bottom: 80px;
      background: #f8f9fa;
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #0d2847;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .splash-image {
      width: 100%;
      max-width: 500px;
      height: auto;
      object-fit: contain;
      animation: zoomInSplash 1.5s ease-out;
      padding: 20px;
    }


    /* Splash confetti container */
    #splash-confetti-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .splash-confetti {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    @keyframes zoomInSplash {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Confetti particles */
    .confetti-particle {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: confettiFall 3s linear infinite;
    }

    @keyframes confettiFall {
      0% { 
        transform: translateY(-100vh) rotate(0deg); 
        opacity: 1; 
      }
      100% { 
        transform: translateY(100vh) rotate(720deg); 
        opacity: 0; 
      }
    }



    .splash-tagline {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.25rem;
      margin-top: 1rem;
      font-style: italic;
    }

    .loading-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 2rem;
    }

    .loading-dots span {
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .splash-hidden {
      animation: fadeOutDown 0.8s ease-in-out forwards;
    }

    @keyframes fadeOutDown {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(30px); }
    }


    /* LOGIN SCREEN ANIMATIONS */
    .login-wrapper {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f97316 0%, #fb923c 50%, #1e3a8a 100%);
      overflow: hidden;
    }

    /* Animated monkeys around login box */
    .monkey-top-left {
      position: absolute;
      top: 8%;
      left: 5%;
      font-size: 60px;
      animation: monkeySwing 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .monkey-top-center {
      position: absolute;
      top: 2%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 70px;
      animation: monkeyDangle 2.8s ease-in-out infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .monkey-top-right {
      position: absolute;
      top: 8%;
      right: 5%;
      font-size: 60px;
      animation: monkeyBounce 2.5s ease-in-out infinite;
      animation-delay: 0.5s;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .monkey-bottom-left {
      position: absolute;
      bottom: 8%;
      left: 5%;
      font-size: 65px;
      animation: monkeyRoll 4s linear infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .monkey-bottom-center {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 75px;
      animation: monkeySpin 3.5s linear infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    .monkey-bottom-right {
      position: absolute;
      bottom: 8%;
      right: 5%;
      font-size: 65px;
      animation: monkeyCartwheel 3s ease-in-out infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
      z-index: 1;
    }

    /* Bananas floating around */
    .banana-float {
      position: absolute;
      font-size: 40px;
      animation: bananaFloat 4s ease-in-out infinite;
      filter: drop-shadow(0 3px 10px rgba(0, 0, 0, 0.2));
      z-index: 1;
    }

    .banana-1 { top: 15%; left: 20%; animation-delay: 0s; }
    .banana-2 { top: 20%; right: 15%; animation-delay: 1s; }
    .banana-3 { bottom: 20%; left: 15%; animation-delay: 2s; }
    .banana-4 { bottom: 15%; right: 20%; animation-delay: 1.5s; }

    @keyframes monkeySwing {
      0%, 100% { transform: rotate(-25deg) translateY(0); }
      50% { transform: rotate(25deg) translateY(-25px); }
    }

    @keyframes monkeyDangle {
      0%, 100% { transform: translateX(-50%) rotate(-10deg) translateY(0); }
      50% { transform: translateX(-50%) rotate(10deg) translateY(20px); }
    }

    @keyframes monkeyBounce {
      0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
      50% { transform: translateY(-35px) scale(1.15) rotate(360deg); }
    }

    @keyframes monkeyRoll {
      0% { transform: rotate(0deg) translateX(0); }
      50% { transform: rotate(180deg) translateX(30px); }
      100% { transform: rotate(360deg) translateX(0); }
    }

    @keyframes monkeySpin {
      0% { transform: translateX(-50%) rotate(0deg) scale(1); }
      50% { transform: translateX(-50%) rotate(180deg) scale(1.2); }
      100% { transform: translateX(-50%) rotate(360deg) scale(1); }
    }

    @keyframes monkeyCartwheel {
      0%, 100% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.1) translateY(-10px); }
      50% { transform: rotate(180deg) scale(1.2) translateY(-20px); }
      75% { transform: rotate(270deg) scale(1.1) translateY(-10px); }
    }

    @keyframes bananaFloat {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-25px) rotate(180deg); }
    }

    /* Circus background elements */
    .circus-stripe {
      position: absolute;
      width: 100%;
      height: 150px;
      background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.1),
        rgba(255, 255, 255, 0.1) 20px,
        transparent 20px,
        transparent 40px
      );
      opacity: 0.3;
      animation: stripeMove 3s linear infinite;
    }

    .circus-stripe:nth-child(1) { top: 10%; animation-delay: 0s; }
    .circus-stripe:nth-child(2) { top: 40%; animation-delay: 1s; }
    .circus-stripe:nth-child(3) { top: 70%; animation-delay: 2s; }

    @keyframes stripeMove {
      from { transform: translateX(-40px); }
      to { transform: translateX(0); }
    }

    .login-box-container {
      position: relative;
      z-index: 10;
    }

    /* Progress bar with candy stripes */
    .progress-bar-container {
      position: relative;
      height: 16px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(
        45deg,
        #10b981 25%,
        #3b82f6 25%,
        #3b82f6 50%,
        #10b981 50%,
        #10b981 75%,
        #3b82f6 75%,
        #3b82f6
      );
      background-size: 40px 40px;
      animation: progressStripes 1s linear infinite;
      transition: width 0.5s ease-in-out;
      border-radius: 10px;
    }

    @keyframes progressStripes {
      from { background-position: 0 0; }
      to { background-position: 40px 0; }
    }

    /* Success Modal */
    .success-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10000;
      background: white;
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.5s ease-out;
      max-width: 90vw;
      width: 400px;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
      border-radius: 50%;
      background: #10b981;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: successBounce 0.6s ease-out;
    }

    @keyframes successBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    /* Bottom Navigation - Game style */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff7ed;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
      z-index: 1000;
      padding: 0.5rem 0;
    }

    .nav-button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      padding: 0.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #6b7280;
      position: relative;
    }

    /* Scan button highlight */
    .nav-button.scan-highlight {
      background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
      color: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4);
      animation: scanPulse 2s ease-in-out infinite;
      transform: scale(1.1);
    }

    .nav-button.scan-highlight::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 16px;
      background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
      opacity: 0.3;
      animation: scanRing 2s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes scanPulse {
      0%, 100% { box-shadow: 0 4px 20px rgba(249, 115, 22, 0.4); }
      50% { box-shadow: 0 8px 30px rgba(249, 115, 22, 0.7); }
    }

    @keyframes scanRing {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.1); opacity: 0.5; }
    }

    .nav-button svg {
      display: block !important;
      width: 24px;
      height: 24px;
    }

    .nav-button.active {
      color: #f97316;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 12px;
    }

    .nav-button:hover {
      color: #f97316;
      background: rgba(249, 115, 22, 0.05);
      border-radius: 12px;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Modal backdrop */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Leaderboard slide-in */
    .leaderboard-slide {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 90%;
      max-width: 500px;
      background: white;
      z-index: 9999;
      overflow-y: auto;
      animation: slideInLeft 0.3s ease-out;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes slideInLeft {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }

    #qr-reader {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    /* Game card styling */
    .game-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: row;
    }

    .game-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(-2px);
    }

    .game-card-image {
      width: 140px;
      min-height: 140px;
      max-height: 200px;
      object-fit: cover;
      object-position: center;
      flex-shrink: 0;
      background: #f9fafb;
      clip-path: inset(3% 0 3% 0);
    }

    @media (max-width: 768px) {
      .game-card-image {
        width: 120px;
        min-height: 120px;
        max-height: 180px;
      }
    }

    /* Score table */
    .score-table-container {
      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .score-table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .score-table th,
    .score-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    @media (max-width: 768px) {
      .score-table {
        font-size: 0.75rem;
      }
      
      .score-table th,
      .score-table td {
        padding: 0.375rem;
      }
    }

    .score-table th {
      background: #f9fafb;
      font-weight: 700;
      color: #374151;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .score-table tr:hover {
      background: #f9fafb;
    }

    /* Stats badge */
    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f3f4f6;
      border-radius: 12px;
      font-size: 0.875rem;
    }

    .stat-value {
      font-weight: 700;
      font-size: 1.125rem;
    }

    /* Fun fair login background */
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease-out;
      max-width: 90%;
      text-align: center;
    }

    .toast.success {
      background: #10b981;
      color: white;
    }

    .toast.error {
      background: #ef4444;
      color: white;
    }

    .toast.info {
      background: #3b82f6;
      color: white;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Custom Modal/Dialog */
    .custom-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease-out;
    }

    .custom-modal {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.75rem;
    }

    .modal-message {
      color: #6b7280;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    .modal-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .modal-btn-cancel {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-btn-cancel:hover {
      background: #e5e7eb;
    }

    .modal-btn-confirm {
      background: #f97316;
      color: white;
    }

    .modal-btn-confirm:hover {
      background: #ea580c;
    }
    /* Done badge */
    .done-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #10b981;
      color: white;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      margin-left: 6px;
    }

    /* Completed game card */
    .game-card.completed {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
    }

    /* QR Code styling */
    #qrcode canvas {
      border: 4px solid #000 !important;
    }
    /* Score highlighting */
    .score-highlight {
      padding: 8px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-weight: 600;
    }
    
    .score-highlight.stage {
      background: #fed7aa;
      border-color: #f97316;
    }
    
    .score-highlight.game {
      background: #dbeafe;
      border-color: #3b82f6;
    }


  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <img src="splash_screen.png" alt="Seva Mela 2025" class="splash-image">
    <div id="splash-confetti-container"></div>
  </div>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <div id="root"></div>

  <script>
    const { useState, useEffect, useRef } = React;

    // Supabase Configuration
    const SUPABASE_URL = 'https://picoefnstacccewynahc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpY29lZm5zdGFjY2Nld3luYWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzg1NDIsImV4cCI6MjA3NDcxNDU0Mn0.UH44tz7g-CTRGpF-FS2Wg4LCHv1LjfBGazGWPvnn0to';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Supabase Helper Functions
    async function savePlayerToSupabase(player) {
      try {
        const { data: playerData, error: playerError } = await supabase
          .from('players')
          .upsert({
            name: player.name,
            category: player.category,
            is_admin: player.isAdmin || false
          }, { onConflict: 'name,category' })
          .select()
          .single();

        if (playerError) throw playerError;

        const gameScores = Object.entries(player.games || {}).map(([gameId, gameData]) => ({
          player_id: playerData.id,
          game_id: gameId,
          scanned: gameData.scanned || false,
          stage_percent: gameData.stagePercent || 0,
          coins_earned: gameData.coinsEarned || 0,
          game_percent: gameData.gamePercent || 0
        }));

        if (gameScores.length > 0) {
          const { error: scoresError } = await supabase
            .from('game_scores')
            .upsert(gameScores, { onConflict: 'player_id,game_id' });
          if (scoresError) throw scoresError;
        }

        return playerData;
      } catch (error) {
        console.error('Supabase save error:', error);
        throw error;
      }
    }

    async function loadPlayersFromSupabase() {
      try {
        const { data: players, error } = await supabase
          .from('players')
          .select(`
            id,
            name,
            category,
            is_admin,
            game_scores (
              game_id,
              scanned,
              stage_percent,
              coins_earned,
              game_percent
            )
          `);

        if (error) throw error;

        return players.map(p => ({
          name: p.name,
          category: p.category,
          isAdmin: p.is_admin,
          games: (p.game_scores || []).reduce((acc, gs) => ({
            ...acc,
            [gs.game_id]: {
              scanned: gs.scanned,
              stagePercent: gs.stage_percent,
              coinsEarned: gs.coins_earned,
              gamePercent: gs.game_percent
            }
          }), {})
        }));
      } catch (error) {
        console.error('Supabase load error:', error);
        return [];
      }
    }

    async function deletePlayerFromSupabase(name, category) {
      try {
        // First get the player ID
        const { data: player, error: findError } = await supabase
          .from('players')
          .select('id')
          .eq('name', name)
          .eq('category', category)
          .single();
        
        if (findError) throw findError;
        if (!player) throw new Error('Player not found');
        
        // Delete game scores first (CASCADE should handle this, but being explicit)
        const { error: scoresError } = await supabase
          .from('game_scores')
          .delete()
          .eq('player_id', player.id);
        
        if (scoresError) throw scoresError;
        
        // Then delete the player
        const { error: deleteError } = await supabase
          .from('players')
          .delete()
          .eq('id', player.id);
          
        if (deleteError) throw deleteError;
      } catch (error) {
        console.error('Supabase delete error:', error);
        throw error;
      }
    }

    const GAMES = [
      { 
        id: 'game1', 
        name: 'Spin-tastic', 
        qrCode: 'GAME1_WHEEL_OF_FORTUNE',
        image: 'wheel_game.png',
        stageName: 'Seeker',
        stageSlogan: 'The first step is seeking the truth within',
        stagePoints: 10,
        gamePoints: 10,
        maxCoins: 30
      },
      { 
        id: 'game2', 
        name: 'Decode the Department', 
        qrCode: 'GAME2_MEMORY_CARD_QUIZ',
        image: 'memory_card.png',
        stageName: 'Explorer',
        stageSlogan: 'Exploration leads to inner discovery',
        stagePoints: 15,
        gamePoints: 15,
        maxCoins: 60
      },
      { 
        id: 'game3', 
        name: 'Volunteer Voyage', 
        qrCode: 'GAME3_PAPER_PLANE',
        image: 'volunteer_journey.png',
        stageName: 'Wanderer',
        stageSlogan: 'Wandering the path, finding your way home',
        stagePoints: 20,
        gamePoints: 30,
        maxCoins: 175
      },
      { 
        id: 'game4', 
        name: 'Anubhav Vriksha', 
        qrCode: 'GAME4_VOLUNTEER_TREE',
        image: 'volunteer_tree.png',
        stageName: 'Yogi',
        stageSlogan: 'The Yogi serves, transforms, and transcends',
        stagePoints: 0,
        gamePoints: 0,
        maxCoins: 0
      }
    ];

    const CATEGORIES = [
      'Sadhanapada',
      'Poornanga',
      'Staff',
      'Resident',
      'Volunteer',
      'Brahmachari',
      'Sevadhar',
      'Samskriti',
      'Admin'
    ];

    const ADMIN_PIN = '3020';

    function Icon({ name, size = 24, className = "" }) {
      const iconRef = useRef(null);
      
      useEffect(() => {
        if (iconRef.current && window.lucide) {
          iconRef.current.innerHTML = '';
          iconRef.current.setAttribute('data-lucide', name);
          window.lucide.createIcons();
        }
      }, [name]);
      
      return React.createElement('i', { 
        ref: iconRef, 
        'data-lucide': name,
        style: { width: size + 'px', height: size + 'px', display: 'inline-block' },
        className: className
      });
    }

    function SevaMelaApp() {
      const [showSplash, setShowSplash] = useState(true);
      const [onboardingComplete, setOnboardingComplete] = useState(false);
      const [userName, setUserName] = useState('');
      const [userCategory, setUserCategory] = useState('');
      const [isAdmin, setIsAdmin] = useState(false);
      const [adminPinInput, setAdminPinInput] = useState('');
      const [participants, setParticipants] = useState([]);
      const [currentUser, setCurrentUser] = useState(null);
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [showQRScanner, setShowQRScanner] = useState(false);
      const [selectedGame, setSelectedGame] = useState(null);
      const [successModalData, setSuccessModalData] = useState(null);
      const [activeView, setActiveView] = useState('home');
      const [toast, setToast] = useState(null);
      const [modal, setModal] = useState(null);
      const [leaderboardSearch, setLeaderboardSearch] = useState('');
      const [adminSearchQuery, setAdminSearchQuery] = useState('');
      const [adminSortBy, setAdminSortBy] = useState('rank');
      const [leaderboardSortBy, setLeaderboardSortBy] = useState('rank');
      const [refreshing, setRefreshing] = useState(false);
      
      const html5QrCodeRef = useRef(null);
      const isScanning = useRef(false);

      const showToast = (message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
      };

      const showModal = (title, message, onConfirm, confirmText = 'OK', showCancel = false) => {
        return new Promise((resolve) => {
          setModal({
            title,
            message,
            onConfirm: () => {
              if (onConfirm) onConfirm();
              setModal(null);
              resolve(true);
            },
            onCancel: () => {
              setModal(null);
              resolve(false);
            },
            confirmText,
            showCancel
          });
        });
      };

      
      const refreshScores = async () => {
        setRefreshing(true);
        const oldParticipants = participants;
        const players = await loadPlayersFromSupabase();
        setParticipants(players);
        
        if (currentUser && !currentUser.isAdmin) {
          const oldUser = oldParticipants.find(p => p.name === currentUser.name && p.category === currentUser.category);
          const updated = players.find(p => p.name === currentUser.name && p.category === currentUser.category);
          
          if (updated && oldUser) {
            let hasUpdate = false;
            GAMES.forEach(game => {
              const oldGamePercent = oldUser.games[game.id]?.gamePercent || 0;
              const newGamePercent = updated.games[game.id]?.gamePercent || 0;
              
              if (newGamePercent > oldGamePercent) {
                hasUpdate = true;
                setSuccessModalData({
                  game: game,
                  isGamePoints: true,
                  pointsEarned: newGamePercent - oldGamePercent
                });
                
                confetti({
                  particleCount: 150,
                  spread: 70,
                  origin: { y: 0.6 },
                  colors: ['#f97316', '#fb923c', '#1e3a8a', '#3b82f6', '#10b981'],
                  zIndex: 10002
                });
                
                setTimeout(() => {
                  setSuccessModalData(null);
                }, 4000);
              }
            });
            setCurrentUser(updated);
            
            if (!hasUpdate) {
              showToast('Scores refreshed!', 'success');
            }
          } else if (updated) {
            setCurrentUser(updated);
            showToast('Scores refreshed!', 'success');
          }
        } else {
          showToast('Scores refreshed!', 'success');
        }
        
        setTimeout(() => setRefreshing(false), 500);
      };


      const showConfirm = (title, message) => {
        return new Promise((resolve) => {
          setModal({
            title,
            message,
            onConfirm: () => {
              setModal(null);
              resolve(true);
            },
            onCancel: () => {
              setModal(null);
              resolve(false);
            },
            confirmText: 'Yes',
            showCancel: true
          });
        });
      };

      useEffect(() => {
        const loadData = async () => {
          const players = await loadPlayersFromSupabase();
          setParticipants(players);
        };
        
        const savedUser = localStorage.getItem('sevaMelaCurrentUser');
        if (savedUser) {
          const user = JSON.parse(savedUser);
          setCurrentUser(user);
          setUserName(user.name);
          setUserCategory(user.category);
          setIsAdmin(user.isAdmin);
          setOnboardingComplete(true);
        }
        
        loadData();
      }, []);

      useEffect(() => {
        if (participants.length > 0) {
          participants.filter(p => !p.isAdmin).forEach(p => savePlayerToSupabase(p).catch(console.error));
        }
      }, [participants]);

      useEffect(() => {
        if (currentUser) {
          localStorage.setItem('sevaMelaCurrentUser', JSON.stringify(currentUser));
        }
      }, [currentUser]);

      useEffect(() => {
        // Create falling confetti particles
        const confettiContainer = document.getElementById('splash-confetti-container');
        if (confettiContainer) {
          const colors = ['#f97316', '#fb923c', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6', '#ec4899'];
          for (let i = 0; i < 80; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'splash-confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = -Math.random() * 100 + 'px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = (Math.random() * 2) + 's';
            confetti.style.animation = `confettiFall ${2.5 + Math.random() * 2}s linear infinite`;
            confetti.style.width = (8 + Math.random() * 8) + 'px';
            confetti.style.height = confetti.style.width;
            confettiContainer.appendChild(confetti);
          }
        }

        const confettiTimer = setTimeout(() => {
          confetti({
            particleCount: 150,
            spread: 90,
            origin: { y: 0.6 }
          });
        }, 300);
        
        const timer = setTimeout(() => {
          const splash = document.getElementById('splash-screen');
          if (splash) {
            splash.classList.add('splash-hidden');
            setTimeout(() => {
              splash.style.display = 'none';
              setShowSplash(false);
            }, 800);
          }
        }, 3000);
        
        return () => {
          clearTimeout(confettiTimer);
          clearTimeout(timer);
        };
      }, []);

      useEffect(() => {
        if (!showSplash && !onboardingComplete) {
          const timer = setTimeout(() => {
            confetti({
              particleCount: 150,
              spread: 80,
              origin: { y: 0.6 }
            });
          }, 100);
          return () => clearTimeout(timer);
        }
      }, [showSplash, onboardingComplete]);

      const handleOnboardingSubmit = () => {
        if (userCategory === 'Admin') {
          if (adminPinInput !== ADMIN_PIN) {
            showToast('Incorrect PIN', 'error');
            return;
          }
          
          const adminUser = {
            name: 'Admin',
            category: 'Admin',
            isAdmin: true,
            games: GAMES.reduce((acc, game) => ({
              ...acc,
              [game.id]: {
                scanned: false,
                stagePercent: 0,
                coinsEarned: 0,
                gamePercent: 0
              }
            }), {})
          };
          
          setCurrentUser(adminUser);
          setUserName('Admin');
          setIsAdmin(true);
          setOnboardingComplete(true);
          confetti({
            particleCount: 200,
            spread: 70,
            origin: { y: 0.6 }
          });
          return;
        }

        if (!userName.trim() || !userCategory) {
          showToast('Enter name & category', 'error');
          return;
        }

        const trimmedName = userName.trim();
        const existingUser = participants.find(p => 
          p.name.toLowerCase() === trimmedName.toLowerCase() && p.category === userCategory
        );
        
        if (existingUser) {
          setCurrentUser(existingUser);
          setUserName(existingUser.name);
          setIsAdmin(existingUser.isAdmin);
          setOnboardingComplete(true);
          showToast(`Welcome back, ${trimmedName}!`, 'info');
          confetti({
            particleCount: 150,
            spread: 60,
            origin: { y: 0.6 }
          });
          return;
        }
        
        const nameExistsElsewhere = participants.find(p => 
          p.name.toLowerCase() === trimmedName.toLowerCase() && p.category !== userCategory
        );
        
        if (nameExistsElsewhere) {
          const result = confirm(
            `Note: "${trimmedName}" is already used by someone in ${nameExistsElsewhere.category} category.\n\n` +
            `You can still use "${trimmedName}" for ${userCategory} category.\n\n` +
            `Click OK to continue with "${trimmedName}"\n` +
            `Click Cancel to choose a different name`
          );
          
          if (result) {
            createNewUser(trimmedName);
          }
          return;
        }
        
        const similarNames = participants.filter(p => 
          p.category === userCategory && (
            p.name.toLowerCase() === trimmedName.toLowerCase() ||
            p.name.toLowerCase().startsWith(trimmedName.toLowerCase() + ' ')
          )
        );
        
        if (similarNames.length > 0) {
          let counter = 1;
          let suggestedName = `${trimmedName} ${counter}`;
          while (participants.find(p => p.name === suggestedName && p.category === userCategory)) {
            counter++;
            suggestedName = `${trimmedName} ${counter}`;
          }
          
          const result = confirm(
            `The name "${trimmedName}" or similar is already taken in ${userCategory} category.\n\n` +
            `Existing: ${similarNames.map(p => p.name).join(', ')}\n\n` +
            `Would you like to use "${suggestedName}" instead?\n\n` +
            `Click OK to use "${suggestedName}"\n` +
            `Click Cancel to choose a different name`
          );
          
          if (result) {
            createNewUser(suggestedName);
          }
          return;
        }
        
        createNewUser(trimmedName);
      };

      const createNewUser = (finalName) => {
        const newUser = {
          name: finalName,
          category: userCategory,
          isAdmin: false,
          games: GAMES.reduce((acc, game) => ({
            ...acc,
            [game.id]: {
              scanned: false,
              stagePercent: 0,
              coinsEarned: 0,
              gamePercent: 0
            }
          }), {})
        };

        const updatedParticipants = [...participants, newUser];
        savePlayerToSupabase(newUser).catch(console.error);
        setParticipants(updatedParticipants);
        setCurrentUser(newUser);
        setUserName(finalName);
        setIsAdmin(false);
        setOnboardingComplete(true);
        confetti({
          particleCount: 200,
          spread: 70,
          origin: { y: 0.6 }
        });
      };

      const calculateProgress = () => {
        if (!currentUser || isAdmin) return 0;
        
        let totalPercent = 0;
        GAMES.forEach(game => {
          const gameData = currentUser.games[game.id];
          if (gameData) {
            totalPercent += (gameData.stagePercent || 0) + (gameData.gamePercent || 0);
          }
        });
        
        return Math.min(100, Math.round(totalPercent));
      };

      const handleQRScan = (decodedText) => {
        console.log('QR Scanned:', decodedText);
        
        if (isAdmin) {
          alert('Admin users cannot scan QR codes');
          return;
        }

        const matchedGame = GAMES.find(g => decodedText.includes(g.qrCode) || decodedText.includes(g.id));
        
        if (matchedGame) {
          if (html5QrCodeRef.current && isScanning.current) {
            html5QrCodeRef.current.stop().then(() => {
              isScanning.current = false;
              setShowQRScanner(false);
            }).catch(err => console.error(err));
          } else {
            setShowQRScanner(false);
          }

          const currentGameData = currentUser.games[matchedGame.id];
          if (currentGameData.scanned) {
            showToast('Already scanned', 'info');
            return;
          }

          const updatedUser = {
            ...currentUser,
            games: {
              ...currentUser.games,
              [matchedGame.id]: {
                ...currentGameData,
                scanned: true,
                stagePercent: matchedGame.stagePoints
              }
            }
          };

          setCurrentUser(updatedUser);
          
          const updatedParticipants = participants.map(p => 
            p.name === currentUser.name && p.category === currentUser.category ? updatedUser : p
          );
          setParticipants(updatedParticipants);

          const scannedCount = Object.values(updatedUser.games).filter(g => g.scanned).length;
          let totalPercent = 0;
          GAMES.forEach(game => {
            const gData = updatedUser.games[game.id];
            totalPercent += (gData.stagePercent || 0) + (gData.gamePercent || 0);
          });

          setSuccessModalData({
            game: matchedGame,
            scannedCount,
            totalProgress: Math.min(100, Math.round(totalPercent))
          });

          confetti({
            particleCount: 200,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#f97316', '#fb923c', '#1e3a8a', '#3b82f6', '#10b981']
          });

          setTimeout(() => {
            setSuccessModalData(null);
          }, 4000);
        } else {
          showToast('Invalid QR code', 'error');
        }
      };

      const startQRScanner = () => {
        setShowQRScanner(true);
        
        setTimeout(() => {
          const qrReaderElement = document.getElementById('qr-reader');
          if (!qrReaderElement) {
            console.error('QR reader element not found');
            return;
          }

          if (!html5QrCodeRef.current) {
            html5QrCodeRef.current = new Html5Qrcode("qr-reader");
          }

          if (!isScanning.current) {
            html5QrCodeRef.current.start(
              { facingMode: "environment" },
              {
                fps: 10,
                qrbox: { width: 250, height: 250 }
              },
              handleQRScan,
              (errorMessage) => {}
            ).then(() => {
              isScanning.current = true;
            }).catch(err => {
              console.error('Camera start error:', err);
              alert('Camera permission denied or not available. Please check settings.');
            });
          }
        }, 100);
      };

      const stopQRScanner = () => {
        if (html5QrCodeRef.current && isScanning.current) {
          html5QrCodeRef.current.stop().then(() => {
            isScanning.current = false;
            setShowQRScanner(false);
          }).catch(err => console.error(err));
        } else {
          setShowQRScanner(false);
        }
      };

      const awardGamePoints = (participantName, participantCategory, gameId, coins) => {
        const game = GAMES.find(g => g.id === gameId);
        
        if (coins < 0 || coins > game.maxCoins) {
          alert(`Coins must be between 0 and ${game.maxCoins}`);
          return false;
        }

        const gamePercent = game.maxCoins > 0 ? Math.round((coins / game.maxCoins) * game.gamePoints) : 0;

        const updatedParticipants = participants.map(p => {
          if (p.name === participantName && p.category === participantCategory) {
            return {
              ...p,
              games: {
                ...p.games,
                [gameId]: {
                  ...p.games[gameId],
                  coinsEarned: coins,
                  gamePercent: gamePercent
                }
              }
            };
          }
          return p;
        });

        const updated = updatedParticipants.find(p => p.name === participantName && p.category === participantCategory);
        if (updated) savePlayerToSupabase(updated).catch(console.error);
        setParticipants(updatedParticipants);
        
        confetti({
          particleCount: 150,
          spread: 70,
          origin: { y: 0.6 },
          colors: ['#f97316', '#fb923c', '#1e3a8a', '#3b82f6', '#10b981'],
          zIndex: 10002
        });

        if (currentUser && currentUser.name === participantName && currentUser.category === participantCategory) {
          const updatedUser = updatedParticipants.find(p => p.name === participantName && p.category === participantCategory);
          setCurrentUser(updatedUser);
        }

        return true;
      };

      const getLeaderboard = () => {
        const allSorted = participants
          .filter(p => !p.isAdmin)
          .map(p => {
            let totalPercent = 0;
            GAMES.forEach(game => {
              const gameData = p.games[game.id];
              totalPercent += gameData.stagePercent + gameData.gamePercent;
            });
            return {
              name: p.name,
              category: p.category,
              totalPercentage: Math.min(100, Math.round(totalPercent))
            };
          })
          .sort((a, b) => {
            if (b.totalPercentage !== a.totalPercentage) {
              return b.totalPercentage - a.totalPercentage;
            }
            // Secondary sort by name for stability
            return a.name.localeCompare(b.name);
          });
        
        // Assign ranks based on percentage only
        let currentRank = 1;
        let previousPercentage = null;
        let playersAtCurrentRank = 0;
        
        const rankedAll = allSorted.map((player, index) => {
          if (previousPercentage === null || player.totalPercentage < previousPercentage) {
            currentRank = currentRank + playersAtCurrentRank;
            playersAtCurrentRank = 1;
            previousPercentage = player.totalPercentage;
          } else {
            playersAtCurrentRank++;
          }
          return { ...player, rank: currentRank };
        });
        
        if (!leaderboardSearch) return rankedAll;
        
        const search = leaderboardSearch.toLowerCase();
        return rankedAll.filter(p => 
          p.name.toLowerCase().includes(search) || 
          p.category.toLowerCase().includes(search)
        );
      };

      const handleRefresh = () => {
        const savedParticipants = localStorage.getItem('sevaMelaParticipants');
        const savedUser = localStorage.getItem('sevaMelaCurrentUser');
        
        if (savedParticipants) {
          setParticipants(JSON.parse(savedParticipants));
        }
        
        if (savedUser) {
          setCurrentUser(JSON.parse(savedUser));
        }
        
        alert('Data refreshed!');
      };

      const deletePlayer = async (playerName, playerCategory) => {
        if (!isAdmin) {
          showToast('Admin only', 'error');
          return;
        }

        const result = await showConfirm('Delete Player', `Remove ${playerName} (${playerCategory})?`);
        if (result) {
          try {
            await deletePlayerFromSupabase(playerName, playerCategory);
            const updatedParticipants = participants.filter(
              p => !(p.name === playerName && p.category === playerCategory)
            );
            setParticipants(updatedParticipants);
            localStorage.setItem('sevaMelaParticipants', JSON.stringify(updatedParticipants));
            showToast('Player deleted from database and local', 'success');
          } catch (error) {
            showToast('Delete failed: ' + error.message, 'error');
          }
        }
      };

      // CSV Export for data backup
      const exportDataAsCSV = () => {
        if (!isAdmin) {
          alert('Only admins can export data');
          return;
        }
        
        const headers = ['Name', 'Category', ...GAMES.map(g => g.name + '_Stage%'), ...GAMES.map(g => g.name + '_Game%'), ...GAMES.map(g => g.name + '_Coins'), 'Total%'];
        const rows = participants
          .filter(p => !p.isAdmin)
          .map(p => {
            const stageScores = GAMES.map(g => p.games[g.id]?.stagePercent || 0);
            const gameScores = GAMES.map(g => p.games[g.id]?.gamePercent || 0);
            const coins = GAMES.map(g => p.games[g.id]?.coinsEarned || 0);
            const total = [...stageScores, ...gameScores].reduce((a,b) => a+b, 0);
            return [p.name, p.category, ...stageScores, ...gameScores, ...coins, Math.min(100, Math.round(total))];
          });
        
        const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `seva-mela-backup-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(url);
        showToast('✓ Data exported', 'success');
      };

      // CSV Import to restore data
      const importDataFromCSV = (event) => {
        if (!isAdmin) {
          alert('Only admins can import data');
          return;
        }
        
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
              alert('Invalid CSV file');
              return;
            }
            
            const restored = [];
            
            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',');
              if (values.length < 2) continue;
              
              const name = values[0].trim();
              const category = values[1].trim();
              
              const games = {};
              GAMES.forEach((game, idx) => {
                games[game.id] = {
                  scanned: values[2 + idx] > 0 || values[2 + GAMES.length + idx] > 0,
                  stagePercent: parseInt(values[2 + idx]) || 0,
                  gamePercent: parseInt(values[2 + GAMES.length + idx]) || 0,
                  coinsEarned: parseInt(values[2 + 2*GAMES.length + idx]) || 0
                };
              });
              
              restored.push({ name, category, isAdmin: false, games });
            }
            
            if (confirm(`Import ${restored.length} participants? This will replace current data.`)) {
              setParticipants([...participants.filter(p => p.isAdmin), ...restored]);
              showToast(`✓ Imported ${restored.length} players`, 'success');
            }
          } catch (err) {
            showToast('Error importing', 'error');
          }
        };
        reader.readAsText(file);
      };

      
      const getFilteredAdminScores = () => {
        let filtered = getScoreTableData();
        
        // Apply search
        if (adminSearchQuery && adminSearchQuery.trim()) {
          const search = adminSearchQuery.toLowerCase();
          filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(search) || 
            p.category.toLowerCase().includes(search)
          );
        }
        
        // Apply sort
        if (adminSortBy === 'name') {
          filtered.sort((a, b) => a.name.localeCompare(b.name));
        } else {
          // Sort by rank (total points descending)
          filtered.sort((a, b) => b.totalPoints - a.totalPoints);
        }
        
        return filtered;
      };

      const getScoreTableData = () => {
        return participants
          .filter(p => !p.isAdmin)
          .map(p => {
            const gameScores = GAMES.map(game => ({
              gameId: game.id,
              gameName: game.name,
              gamePercent: p.games[game.id]?.gamePercent || 0,
              stagePercent: p.games[game.id]?.stagePercent || 0,
              scanned: p.games[game.id]?.scanned || false
            }));
            
            const totalPoints = gameScores.reduce(
              (sum, g) => sum + g.gamePercent + g.stagePercent,
              0
            );

            return {
              ...p,
              gameScores,
              totalPoints: Math.min(100, Math.round(totalPoints))
            };
          })
          .sort((a, b) => b.totalPoints - a.totalPoints);
      };

      if (!onboardingComplete) {
        return React.createElement('div', { 
          className: "login-wrapper"
        },
          React.createElement('div', { className: "circus-stripe", style: { top: '10%' } }),
          React.createElement('div', { className: "circus-stripe", style: { top: '40%' } }),
          React.createElement('div', { className: "circus-stripe", style: { top: '70%' } }),
          
          React.createElement('div', { className: "monkey-top-left" }, '🐒'),
          React.createElement('div', { className: "monkey-top-center" }, '🙈'),
          React.createElement('div', { className: "monkey-top-right" }, '🐵'),
          React.createElement('div', { className: "monkey-bottom-left" }, '🙉'),
          React.createElement('div', { className: "monkey-bottom-center" }, '🐒'),
          React.createElement('div', { className: "monkey-bottom-right" }, '🙊'),
          
          React.createElement('div', { className: "banana-float banana-1" }, '🍌'),
          React.createElement('div', { className: "banana-float banana-2" }, '🍌'),
          React.createElement('div', { className: "banana-float banana-3" }, '🍌'),
          React.createElement('div', { className: "banana-float banana-4" }, '🍌'),
          
          React.createElement('div', { className: "login-box-container" },
            React.createElement('div', { className: "bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-500" },
            React.createElement('div', { className: "text-center mb-8" },
              React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-2" }, 'Seva Mela'),
              React.createElement('p', { className: "text-lg font-semibold text-orange-600" }, 'VCD Department')
            ),
            
            React.createElement('div', { className: "space-y-6" },
              userCategory !== 'Admin' && React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-bold text-gray-700 mb-2" }, 'Your Name'),
                React.createElement('input', {
                  type: "text",
                  value: userName,
                  onChange: (e) => setUserName(e.target.value),
                  placeholder: "Enter your name",
                  className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-orange-500 transition-all"
                }),
                React.createElement('div', { className: "min-h-[2rem]" },
                  userName.trim() && userCategory && (() => {
                    const trimmedName = userName.trim();
                    const exactMatch = participants.find(p => 
                      p.name.toLowerCase() === trimmedName.toLowerCase() && p.category === userCategory
                    );
                    
                    if (exactMatch) {
                      return React.createElement('div', { className: "text-xs text-blue-600 bg-blue-50 px-3 py-2 rounded-lg" },
                        `✓ Account exists. Click "Start Journey" to continue.`
                      );
                    }
                    return null;
                  })()
                )
              ),

              React.createElement('div', null,
                React.createElement('label', { className: "block text-sm font-bold text-gray-700 mb-2" }, 'Category'),
                React.createElement('select', {
                  value: userCategory,
                  onChange: (e) => {
                    setUserCategory(e.target.value);
                    setAdminPinInput('');
                  },
                  className: "w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-orange-500 transition-all"
                },
                  React.createElement('option', { value: "" }, 'Select your category...'),
                  CATEGORIES.map(cat =>
                    React.createElement('option', { key: cat, value: cat }, cat)
                  )
                )
              ),

              userCategory === 'Admin' && React.createElement('div', { className: "bg-orange-50 border border-orange-200 rounded-xl p-4" },
                React.createElement('label', { className: "block text-xs font-semibold text-orange-700 mb-2 uppercase tracking-wide" }, 'Admin PIN'),
                React.createElement('input', {
                  type: "password",
                  value: adminPinInput,
                  onChange: (e) => setAdminPinInput(e.target.value),
                  placeholder: "••••",
                  className: "w-full px-4 py-3 border border-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                })
              ),

              React.createElement('button', {
                onClick: handleOnboardingSubmit,
                className: "w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-xl font-bold text-lg hover:scale-105 transition-all shadow-lg"
              }, 'Start Journey')
            )
          )
          )
        );
      }

      const progress = calculateProgress();
      const leaderboard = getLeaderboard();
      const currentUserRank = leaderboard.findIndex(l => l.name === currentUser?.name && l.category === currentUser?.category) + 1;

      return React.createElement('div', { className: "min-h-screen bg-gray-50" },
        // Toast Notification
        toast && React.createElement('div', { 
          className: `toast ${toast.type}`,
          onClick: () => setToast(null)
        }, toast.message),

        // Custom Modal
        modal && React.createElement('div', { className: "custom-modal-backdrop", onClick: modal.showCancel ? modal.onCancel : null },
          React.createElement('div', { className: "custom-modal", onClick: (e) => e.stopPropagation() },
            React.createElement('div', { className: "modal-title" }, modal.title),
            React.createElement('div', { className: "modal-message" }, modal.message),
            React.createElement('div', { className: "modal-buttons" },
              modal.showCancel && React.createElement('button', {
                onClick: modal.onCancel,
                className: "modal-btn modal-btn-cancel"
              }, 'Cancel'),
              React.createElement('button', {
                onClick: modal.onConfirm,
                className: "modal-btn modal-btn-confirm"
              }, modal.confirmText)
            )
          )
        ),

        // Header with VCD Department
        React.createElement('div', { 
          className: "border-b border-gray-200 p-4 sticky top-0 z-50 shadow-sm",
          style: { background: '#fff7ed' }
        },
          React.createElement('div', { className: "flex items-center justify-between max-w-7xl mx-auto" },
            React.createElement('div', { className: "flex items-center gap-3" },
              React.createElement('div', null,
                React.createElement('h1', { className: "text-xl font-bold text-gray-800" }, 
                  'Seva Mela'
                ),
                React.createElement('p', { className: "text-sm text-orange-600 font-medium" }, 'VCD Department')
              ),
              isAdmin && React.createElement('div', { className: "text-right" },
              React.createElement('div', { className: "text-xl font-bold text-gray-800 bg-orange-100 px-4 py-1 rounded-full border-2 border-orange-400" }, 'Admin')
            )
            ),
            !isAdmin && React.createElement('div', { className: "text-right" },
              React.createElement('div', { className: "text-xl font-bold text-gray-800" }, currentUser?.name),
              React.createElement('div', { className: "text-sm text-gray-500" }, `(${currentUser?.category})`)
            )
          ),
          
          // Progress bar with score and rank
          !isAdmin && React.createElement('div', { className: "mt-3 max-w-7xl mx-auto" },
            React.createElement('div', { className: "flex items-center gap-4" },
              React.createElement('div', { className: "flex-1" },
                React.createElement('div', { className: "progress-bar-container" },
                  React.createElement('div', {
                    className: "progress-fill",
                    style: { width: `${progress}%` }
                  })
                )
              ),
              React.createElement('div', { className: "flex gap-3" },
                React.createElement('div', { className: "text-center px-3 py-1 bg-orange-50 rounded-lg" },
                  React.createElement('div', { className: "text-xs text-gray-500" }, 'Score'),
                  React.createElement('div', { className: "text-lg font-bold text-orange-600" }, `${progress}%`)
                ),
                currentUserRank > 0 && React.createElement('div', { className: "text-center px-3 py-1 bg-blue-50 rounded-lg" },
                  React.createElement('div', { className: "text-xs text-gray-500" }, 'Rank'),
                  React.createElement('div', { className: "text-lg font-bold text-blue-600" }, `#${currentUserRank}`)
                )
              )
            )
          )
        ),

        // Main Content
        React.createElement('div', { className: "p-4 max-w-7xl mx-auto pb-24" },
          activeView === 'scores' && isAdmin ? React.createElement('div', null,
            React.createElement('div', { className: "bg-white rounded-xl p-4 mb-4 shadow-sm" },
              React.createElement('div', { className: "flex gap-2" },
                React.createElement('input', {
                  type: 'text',
                  placeholder: 'Search players...',
                  value: adminSearchQuery,
                  onChange: (e) => setAdminSearchQuery(e.target.value),
                  className: 'flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500'
                }),
                React.createElement('select', {
                  value: adminSortBy,
                  onChange: (e) => setAdminSortBy(e.target.value),
                  className: 'px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-orange-500 min-w-fit'
                },
                  React.createElement('option', { value: 'rank' }, 'By Rank'),
                  React.createElement('option', { value: 'name' }, 'By Name')
                )
              )
            ),
            
            React.createElement('div', { className: "space-y-4" },
              getFilteredAdminScores().length === 0 ? React.createElement('div', { className: "text-center text-gray-500 py-8" },
                React.createElement('p', null, 'No players yet')
              ) : getFilteredAdminScores().map(player =>
                React.createElement('div', { 
                  key: `${player.name}-${player.category}`,
                  className: "bg-white rounded-xl shadow-sm border border-gray-200 p-4"
                },
                  // Player header
                  React.createElement('div', { className: "flex items-center justify-between mb-3 pb-3 border-b border-gray-200" },
                    React.createElement('div', null,
                      React.createElement('div', { className: "font-bold text-base text-gray-800" }, player.name),
                      React.createElement('div', { className: "text-xs text-gray-500" }, player.category)
                    ),
                    React.createElement('div', { className: "text-xl font-bold text-orange-600" }, `${player.totalPoints}%`)
                  ),
                  // Game scores grid
                  React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-2 gap-2" },
                    player.gameScores.map(score =>
                      React.createElement('div', { 
                        key: score.gameId,
                        className: `p-2 rounded-lg ${score.scanned ? 'bg-orange-50 border border-orange-200' : 'bg-gray-50 border border-gray-200'}`
                      },
                        React.createElement('div', { className: "text-xs font-semibold text-gray-700 mb-1" }, score.gameName),
                        score.scanned 
                          ? React.createElement('div', { className: "flex flex-col gap-1" },
                              score.gamePercent > 0 && React.createElement('div', { className: "font-bold text-base text-green-600" }, `G:${score.gamePercent}%`),
                              React.createElement('div', { className: "font-bold text-base text-orange-600" }, `S:${score.stagePercent}%`)
                            )
                          : React.createElement('div', { className: 'text-xs text-gray-400' }, 'Not started')
                      )
                    )
                  )
                )
              )
            )
          ) : React.createElement('div', null,
            // Game cards
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4" },
              GAMES.map(game => {
                const gameData = currentUser?.games?.[game.id];
                const currentStage = gameData?.scanned ? game.stageName : 'Not Started';
                const pendingPlayers = isAdmin ? participants.filter(p => 
                  !p.isAdmin && 
                  p.games[game.id]?.scanned && 
                  game.gamePoints > 0 && 
                  p.games[game.id]?.coinsEarned === 0
                ) : [];

                const isCompleted = !isAdmin && gameData?.scanned && gameData?.gamePercent > 0;
                const tintClass = gameData?.scanned ? 'bg-orange-50 border-2 border-orange-200' : 'border-2 border-gray-200';
                return React.createElement('div', {
                  key: game.id,
                  className: `game-card ${isAdmin ? 'cursor-pointer' : ''} ${tintClass}`,
                  onClick: () => isAdmin && setSelectedGame(game)
                },
                  React.createElement('img', {
                    src: game.image,
                    alt: game.name,
                    className: 'game-card-image',
                    onError: (e) => {
                      e.target.style.display = 'none';
                    }
                  }),
                  
                  React.createElement('div', { className: "p-4 flex-1 flex flex-col" },
                    // Title row with Done badge
                    React.createElement('div', { className: "flex items-center mb-1" },
                      React.createElement('h3', { className: "font-bold text-lg text-gray-800 flex-1" }, game.name),
                      gameData?.scanned && !isAdmin && React.createElement('div', { 
                        className: "px-3 py-1 bg-lime-200 border-2 border-lime-700 text-lime-900 rounded-full text-xs font-bold ml-2" 
                      },
                        '✓ Done'
                      )
                    ),

                    // Stage name row
                    React.createElement('div', { className: "mb-3" },
                      gameData?.scanned && !isAdmin
                        ? React.createElement('p', { className: "text-sm font-semibold text-orange-600" }, game.stageName)
                        : !isAdmin && React.createElement('p', { className: "text-sm text-gray-500" }, '🔒 Not Started')
                    ),

                    // Points section
                    !isAdmin ? React.createElement('div', { className: "space-y-1" },
                      game.gamePoints > 0 && React.createElement('div', { className: "flex items-center" },
                        React.createElement('span', { className: "text-xs text-gray-600 flex-1" }, 'Game Points'),
                        React.createElement('span', { className: "font-bold text-lg text-blue-600 ml-2" }, 
                          `🪙 ${gameData?.coinsEarned || 0} (${gameData?.gamePercent || 0}%)`
                        )
                      ),
                      React.createElement('div', { className: "flex items-center" },
                        React.createElement('span', { className: "text-xs text-gray-600 flex-1" }, 'Stage Points'),
                        React.createElement('span', { className: "font-bold text-lg text-orange-600 ml-2" }, 
                          `${gameData?.stagePercent || 0}%`
                        )
                      )
                    ) : React.createElement('div', { className: "flex items-center" },
                      React.createElement('span', { className: "text-xs text-gray-600 flex-1" }, 'Pending'),
                      React.createElement('span', { 
                        className: `font-bold text-xl ml-2 ${pendingPlayers.length > 0 ? 'text-red-600' : 'text-gray-400'}` 
                      }, pendingPlayers.length)
                    )
                  )
                );
              })
            )
          )
        ),

        // Success Modal
        successModalData && React.createElement('div', { className: "modal-backdrop" },
          React.createElement('div', { className: "success-modal" },
            React.createElement('div', { className: "text-center" },
              React.createElement('div', { className: "text-6xl mb-3 animate-bounce" }, '🎉'),
              React.createElement('div', { className: "success-checkmark" },
                React.createElement(Icon, { name: 'Check', size: 48, className: 'text-white' })
              ),
              React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-2" }, 
                successModalData.isGamePoints 
                  ? `Game Points Awarded!`
                  : `${successModalData.game.stageName} Unlocked!`
              ),
              React.createElement('p', { className: "text-lg font-semibold text-orange-600 mb-3" },
                successModalData.game.name
              ),
              !successModalData.isGamePoints && React.createElement('p', { className: "text-sm italic text-gray-600 mb-4 px-4" },
                `"${successModalData.game.stageSlogan}"`
              ),
              React.createElement('div', { className: "bg-orange-50 rounded-xl p-4 mb-4 border border-orange-200" },
                successModalData.isGamePoints 
                  ? React.createElement('div', null,
                      React.createElement('div', { className: "text-sm text-gray-600 mb-1" }, 'Points Earned'),
                      React.createElement('div', { className: "text-3xl font-bold text-orange-600" },
                        `+${successModalData.pointsEarned}%`
                      )
                    )
                  : React.createElement('div', null,
                      React.createElement('div', { className: "text-sm text-gray-600 mb-1" },
                        `Stage ${successModalData.scannedCount} of ${GAMES.length}`
                      ),
                      React.createElement('div', { className: "text-3xl font-bold text-orange-600" },
                        `${successModalData.totalProgress}%`
                      )
                    )
              ),
              !successModalData.isGamePoints && React.createElement('p', { className: "text-sm text-gray-500" },
                successModalData.scannedCount === GAMES.length 
                  ? 'Journey complete! 🙏' 
                  : 'Continue your journey...'
              )
            )
          )
        ),

        // QR Scanner Modal
        showQRScanner && React.createElement('div', { className: "modal-backdrop", onClick: stopQRScanner },
          React.createElement('div', {
            className: "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md z-9999",
            onClick: (e) => e.stopPropagation()
          },
            React.createElement('div', { className: "flex justify-between items-center mb-4" },
              React.createElement('h3', { className: "text-xl font-bold text-gray-800" }, 'Scan QR Code'),
              React.createElement('button', {
                onClick: stopQRScanner,
                className: "text-gray-400 hover:text-gray-600"
              },
                React.createElement(Icon, { name: 'X', size: 24 })
              )
            ),
            React.createElement('div', { id: "qr-reader", className: "mb-4 rounded-xl overflow-hidden" }),
            React.createElement('p', { className: "text-sm text-gray-600 text-center" }, 'Position the QR code within the frame')
          )
        ),

        // Leaderboard
        showLeaderboard && React.createElement('div', { className: "modal-backdrop", onClick: () => setShowLeaderboard(false) },
          React.createElement('div', {
            className: "leaderboard-slide p-6",
            onClick: (e) => e.stopPropagation()
          },
            React.createElement('div', { className: "flex justify-between items-center mb-6" },
              React.createElement('h3', { className: "text-2xl font-bold text-gray-800 flex items-center gap-2" },
                React.createElement(Icon, { name: 'Trophy', size: 28, className: 'text-orange-600' }),
                'Leaderboard'
              ),
              React.createElement('button', {
                onClick: () => setShowLeaderboard(false),
                className: "text-gray-400 hover:text-gray-600"
              },
                React.createElement(Icon, { name: 'X', size: 24 })
              )
            ),

            React.createElement('input', {
              type: 'text',
              placeholder: 'Search players...',
              value: leaderboardSearch,
              onChange: (e) => setLeaderboardSearch(e.target.value),
              className: 'w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:border-orange-500'
            }),

            !isAdmin && currentUserRank > 0 && React.createElement('div', { className: "bg-gradient-to-r from-orange-50 to-blue-50 border-2 border-orange-400 rounded-xl p-4 mb-6" },
              React.createElement('div', { className: "flex justify-between items-center" },
                React.createElement('div', null,
                  React.createElement('div', { className: "font-bold text-gray-800" }, `${currentUser.name}`),
                  React.createElement('div', { className: "text-sm text-gray-600" }, `${currentUser.category}`)
                ),
                React.createElement('div', { className: "text-right" },
                  React.createElement('div', { className: "text-3xl font-bold text-orange-600" }, `${progress}%`),
                  React.createElement('div', { className: "text-xs text-gray-600" }, `Rank #${currentUserRank}`)
                )
              )
            ),

            leaderboard.length === 0 ? React.createElement('div', { className: "text-center text-gray-500 py-12" },
              React.createElement('p', null, 'No participants yet')
            ) : React.createElement('div', { className: "space-y-3" },
              leaderboard.map((player) => {
                const getTrophyEmoji = (rank) => {
                  if (rank === 1) return '🥇';
                  if (rank === 2) return '🥈';
                  if (rank === 3) return '🥉';
                  return '🏅';
                };
                const getTrophyColor = (rank) => {
                  if (rank === 1) return 'text-yellow-500';
                  if (rank === 2) return 'text-gray-400';
                  if (rank === 3) return 'text-orange-600';
                  return 'text-blue-500';
                };
                return React.createElement('div', {
                  key: `${player.name}-${player.category}`,
                  className: `p-4 rounded-xl border-2 ${
                    player.rank <= 3 ? 'bg-gradient-to-r from-yellow-50 to-amber-50 border-yellow-400' : 'bg-white border-gray-200'
                  }`
                },
                  React.createElement('div', { className: "flex justify-between items-center" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                      React.createElement('div', { className: `text-3xl ${getTrophyColor(player.rank)}` },
                        getTrophyEmoji(player.rank)
                      ),
                      React.createElement('div', null,
                        React.createElement('div', { className: "font-bold text-gray-800" }, player.name),
                        React.createElement('div', { className: "text-xs text-gray-600" }, player.category)
                      )
                    ),
                    React.createElement('div', { className: "flex items-center gap-4" },
                      React.createElement('div', { className: "text-center" },
                        React.createElement('div', { className: "text-xs text-gray-500 mb-1" }, 'Rank'),
                        React.createElement('div', { className: `text-2xl font-bold ${player.rank <= 3 ? getTrophyColor(player.rank) : 'text-blue-600'}` }, `#${player.rank}`)
                      ),
                      React.createElement('div', { className: "text-center" },
                        React.createElement('div', { className: "text-xs text-gray-500 mb-1" }, 'Score'),
                        React.createElement('div', { className: `text-2xl font-bold ${player.rank <= 3 ? getTrophyColor(player.rank) : 'text-orange-600'}` }, `${player.totalPercentage}%`)
                      ),
                      isAdmin && React.createElement('button', {
                        onClick: (e) => {
                          e.stopPropagation();
                          deletePlayer(player.name, player.category);
                        },
                        className: "p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all"
                      },
                        React.createElement(Icon, { name: 'Trash2', size: 18 })
                      )
                    )
                  )
                );
              })
            )
          )
        ),

        // Admin Game Modal
        isAdmin && selectedGame && React.createElement('div', { className: "modal-backdrop", onClick: () => setSelectedGame(null) },
          React.createElement('div', {
            className: "fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg z-9999 max-h-[80vh] overflow-y-auto",
            onClick: (e) => e.stopPropagation()
          },
            React.createElement('div', { className: "flex justify-between items-center mb-6" },
              React.createElement('h3', { className: "text-xl font-bold text-gray-800" }, selectedGame.name),
              React.createElement('button', {
                onClick: () => setSelectedGame(null),
                className: "text-gray-400 hover:text-gray-600"
              },
                React.createElement(Icon, { name: 'X', size: 24 })
              )
            ),

            React.createElement('h4', { className: "font-bold text-gray-700 mb-4" }, 'Pending Players'),

            React.createElement('div', { className: "space-y-4" },
              participants.filter(p => {
                if (!p || p.isAdmin) return false;
                if (!p.games || !p.games[selectedGame.id]) return false;
                if (!p.games[selectedGame.id].scanned) return false;
                if (selectedGame.gamePoints <= 0) return false;
                if (p.games[selectedGame.id].coinsEarned > 0) return false;
                return true;
              }).length === 0 ? React.createElement('div', { className: "text-center text-gray-500 py-8" },
                React.createElement('p', null, 'No pending players')
              ) : participants.filter(p => {
                if (!p || p.isAdmin) return false;
                if (!p.games || !p.games[selectedGame.id]) return false;
                if (!p.games[selectedGame.id].scanned) return false;
                if (selectedGame.gamePoints <= 0) return false;
                if (p.games[selectedGame.id].coinsEarned > 0) return false;
                return true;
              }).map(player => 
                React.createElement('div', {
                  key: `${player.name}-${player.category}`,
                  className: "bg-gray-50 border border-gray-200 rounded-xl p-4"
                },
                  React.createElement('div', { className: "font-bold text-gray-800 mb-3" },
                    `${player.name} (${player.category})`
                  ),
                  React.createElement('div', { className: "flex gap-2" },
                    React.createElement('input', {
                      type: "number",
                      id: `points-${player.name}-${player.category}`,
                      placeholder: `Coins (0-${selectedGame.maxCoins})`,
                      min: "0",
                      max: selectedGame.maxCoins.toString(),
                      className: "flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-orange-500"
                    }),
                    React.createElement('button', {
                      onClick: async () => {
                        const input = document.getElementById(`points-${player.name}-${player.category}`);
                        const coins = parseInt(input.value) || 0;
                        
                        const result = await showConfirm('Award Points', `Award ${coins} coins to ${player.name}?`);
                        if (result && awardGamePoints(player.name, player.category, selectedGame.id, coins)) {
                          const gamePercent = selectedGame.maxCoins > 0 ? Math.round((coins / selectedGame.maxCoins) * selectedGame.gamePoints) : 0;
                          showToast(`✓ ${coins} coins = ${gamePercent}%`, 'success');
                          input.value = '';
                        }
                      },
                      className: "px-6 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-bold hover:scale-105 transition-all"
                    }, 'Award')
                  )
                )
              )
            )
          )
        ),

        // Bottom Navigation
        React.createElement('div', { className: "bottom-nav" },
          React.createElement('div', { className: "flex max-w-7xl mx-auto" },
            !isAdmin && React.createElement('button', {
              onClick: startQRScanner,
              className: "nav-button scan-highlight"
            },
              React.createElement('div', { style: { fontSize: '28px' } }, '📷'),
              React.createElement('div', { className: "nav-label" }, 'Scan')
            ),
            React.createElement('button', {
              onClick: () => setShowLeaderboard(true),
              className: `nav-button ${showLeaderboard ? 'active' : ''}`
            },
              React.createElement('div', { style: { fontSize: '24px' } }, '🏆'),
              React.createElement('div', { className: "nav-label" }, 'Board')
            ),
            React.createElement('button', {
              onClick: refreshScores,
              className: `nav-button ${refreshing ? 'active' : ''}`
            },
              React.createElement('div', { style: { fontSize: '24px' } }, '🔄'),
              React.createElement('div', { className: "nav-label" }, 'Refresh')
            ),
            isAdmin && React.createElement('button', {
              onClick: () => setActiveView('home'),
              className: `nav-button ${activeView === 'home' ? 'active' : ''}`
            },
              React.createElement('div', { style: { fontSize: '24px' } }, '🏠'),
              React.createElement('div', { className: "nav-label" }, 'Home')
            ),
            isAdmin && React.createElement('button', {
              onClick: () => setActiveView(activeView === 'scores' ? 'home' : 'scores'),
              className: `nav-button ${activeView === 'scores' ? 'active' : ''}`
            },
              React.createElement('div', { style: { fontSize: '24px' } }, '📊'),
              React.createElement('div', { className: "nav-label" }, 'Scores')
            ),
            React.createElement('button', {
              onClick: async () => {
                const result = await showConfirm('Logout', 'Are you sure you want to logout?');
                if (result) {
                  localStorage.removeItem('sevaMelaCurrentUser');
                  window.location.reload();
                }
              },
              className: "nav-button"
            },
              React.createElement('div', { style: { fontSize: '24px' } }, '🚪'),
              React.createElement('div', { className: "nav-label" }, 'Logout')
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(SevaMelaApp));
  </script>
</body>
</html>